<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fit multilevel model to evoked responses using lme4 • mne</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Fit multilevel model to evoked responses using lme4">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mne</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/plot_compute_evoked_in_r.html">Compute evoked response in R</a>
    </li>
    <li>
      <a href="../articles/plot_evoked_multilevel_model.html">Fit multilevel model to evoked responses using lme4</a>
    </li>
    <li>
      <a href="../articles/plot_machine_learning_evoked.html">Using machine learning to analyze evoked responses</a>
    </li>
    <li>
      <a href="../articles/plot_process_evoked.html">Processing MEG and EEG from raw to evoked</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mne-tools/mne-r">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Fit multilevel model to evoked responses using lme4</h1>
                        <h4 class="author">Denis A. Engemann</h4>
            <address class="author_afil">
      INRIA Saclay, Parietal <a href="mailto:denis-alexander.engemann@inria.fr" class="email">denis-alexander.engemann@inria.fr</a><br><small class="dont-index">Source: <a href="https://github.com/mne-tools/mne-r/blob/master/vignettes/plot_evoked_multilevel_model.Rmd"><code>vignettes/plot_evoked_multilevel_model.Rmd</code></a></small>
      <div class="hidden name"><code>plot_evoked_multilevel_model.Rmd</code></div>

    </address>
</div>

    
    
<p>Here we will use a multilevel model to assess the difference between two conditions over time. For now we will stick with the <code>lme4</code> optimization-based implementation and use the parametric bootstrap for uncertainty estimation. Bayesian inference will be covered in a future example.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tidyverse)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(lme4)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(merTools)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(mne)</a></code></pre></div>
<pre><code>## Importing MNE version=0.18.dev0, path='/Users/dengeman/github/mne-python/mne'</code></pre>
<p>Let’s read in the raw data.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">data_path &lt;-<span class="st"> </span>mne<span class="op">$</span>datasets<span class="op">$</span>sample<span class="op">$</span><span class="kw">data_path</span>()</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">subject &lt;-<span class="st"> "sample"</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"></a>
<a class="sourceLine" id="cb3-4" data-line-number="4">raw_fname &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(data_path,</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">                   <span class="st">'MEG'</span>, </a>
<a class="sourceLine" id="cb3-6" data-line-number="6">                   subject,</a>
<a class="sourceLine" id="cb3-7" data-line-number="7">                   <span class="st">'sample_audvis_filt-0-40_raw.fif'</span>,</a>
<a class="sourceLine" id="cb3-8" data-line-number="8">                   <span class="dt">sep =</span> <span class="st">'/'</span>)</a>
<a class="sourceLine" id="cb3-9" data-line-number="9"></a>
<a class="sourceLine" id="cb3-10" data-line-number="10">raw &lt;-<span class="st"> </span>mne<span class="op">$</span>io<span class="op">$</span><span class="kw">read_raw_fif</span>(raw_fname, <span class="dt">preload =</span> T)</a></code></pre></div>
<p>We can now go ahead and compute evokeds.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">events &lt;-<span class="st"> </span>mne<span class="op">$</span><span class="kw">find_events</span>(raw)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mode">storage.mode</a></span>(events) &lt;-<span class="st"> "integer"</span>  <span class="co"># R gets the events as floats.</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"></a>
<a class="sourceLine" id="cb4-4" data-line-number="4">tmin &lt;-<span class="st"> </span><span class="fl">-0.2</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5">tmax &lt;-<span class="st"> </span><span class="fl">0.5</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6">baseline &lt;-<span class="st"> </span>reticulate<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/reticulate/topics/tuple">tuple</a></span>(<span class="ot">NULL</span>, <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb4-7" data-line-number="7">event_id &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="st">"aud/l"</span> =<span class="st"> </span>1L, <span class="st">"vis/l"</span> =<span class="st"> </span>3L)</a>
<a class="sourceLine" id="cb4-8" data-line-number="8">picks &lt;-<span class="st"> </span>mne<span class="op">$</span><span class="kw">pick_channels</span>(raw<span class="op">$</span>ch_names, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="st">'MEG 1332'</span>))</a>
<a class="sourceLine" id="cb4-9" data-line-number="9">epochs &lt;-<span class="st"> </span>mne<span class="op">$</span><span class="kw">Epochs</span>(<span class="dt">raw =</span> raw, <span class="dt">events =</span> events, <span class="dt">event_id =</span> event_id,</a>
<a class="sourceLine" id="cb4-10" data-line-number="10">                     <span class="dt">tmin =</span> tmin, <span class="dt">tmax =</span> tmax,</a>
<a class="sourceLine" id="cb4-11" data-line-number="11">                     <span class="dt">picks =</span> picks <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/integer">as.integer</a></span>(),</a>
<a class="sourceLine" id="cb4-12" data-line-number="12">                     <span class="dt">baseline =</span> baseline, <span class="dt">reject =</span> <span class="ot">NULL</span>, <span class="dt">preload =</span> T) </a></code></pre></div>
<p>Let’s get the epochs into a dataframe.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co"># use MNE-R function.</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2">epochs_df &lt;-<span class="st"> </span>mne<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/mne/topics/get_data_frame">get_data_frame</a></span>(epochs)</a></code></pre></div>
<p>Now we can set up a simple varying effects model:</p>
<p><span class="math display">\[
y_i \sim N(\alpha + \alpha[j] + T\beta[j]_i, \sigma^2)
\]</span> Where <span class="math inline">\(y_i\)</span> is the MEG observation at a given epoch and time point, <span class="math inline">\(\alpha\)</span> is the global intercept, <span class="math inline">\(\alpha[j]\)</span> the intercept of each tome point, <span class="math inline">\(T\)</span> is our treatment information, and <span class="math inline">\(\beta[j]\)</span> is the estimated treatment effect over all <span class="math inline">\(j\)</span> time points of the epoch. The multilevel model will learn a population-shrinkage that depewnds on the variance over the time.</p>
<p>One of the assumptions of this model is that all <span class="math inline">\(J\)</span> coefficients come from a common distribution:</p>
<p><span class="math display">\[
\beta_{j} \sim N(\mu_{\beta[j]}, \sigma_{j}^2)
\]</span> This is what makes this model one model instead of <span class="math inline">\(j\)</span> separate models. In this model, all <span class="math inline">\(j\)</span> coefficients are shrunk to <span class="math inline">\(\mu_j\)</span> to an extent that is proportional to the variance of the group effects.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">mod1 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/lme4/topics/lmer">lmer</a></span>(observation <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>condition <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>condition <span class="op">|</span><span class="st"> </span>time),</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">             <span class="dt">data =</span> epochs_df)</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">mod1 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>()</a></code></pre></div>
<pre><code>## Linear mixed model fit by REML ['lmerMod']
## Formula: observation ~ 1 + condition + (1 + condition | time)
##    Data: epochs_df
## 
## REML criterion at convergence: 177903.2
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -5.9168 -0.6324 -0.0012  0.6395  4.2404 
## 
## Random effects:
##  Groups   Name           Variance Std.Dev. Corr 
##  time     (Intercept)    2003     44.76         
##           conditionvis/l 2506     50.06    -0.94
##  Residual                6032     77.67         
## Number of obs: 15370, groups:  time, 106
## 
## Fixed effects:
##                Estimate Std. Error t value
## (Intercept)      10.050      4.437   2.265
## conditionvis/l  -21.756      5.021  -4.333
## 
## Correlation of Fixed Effects:
##             (Intr)
## conditnvs/l -0.927</code></pre>
<p>As often, looking at the coefficients and text summaries of such models is not tremendously helpful. We will instead generate predictions.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">probe &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/expand.grid">expand.grid</a></span>(</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">  <span class="dt">condition =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"aud/l"</span>, <span class="st">"vis/l"</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(),</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">  <span class="dt">time =</span> epochs_df<span class="op">$</span>time <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>()</a>
<a class="sourceLine" id="cb8-4" data-line-number="4">)</a>
<a class="sourceLine" id="cb8-5" data-line-number="5"></a>
<a class="sourceLine" id="cb8-6" data-line-number="6">pred_mod1 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/predict">predict</a></span>(mod1, probe)</a>
<a class="sourceLine" id="cb8-7" data-line-number="7">probe<span class="op">$</span>pred &lt;-<span class="st"> </span>pred_mod1 </a>
<a class="sourceLine" id="cb8-8" data-line-number="8"></a>
<a class="sourceLine" id="cb8-9" data-line-number="9"><span class="kw">ggplot</span>(<span class="dt">data =</span> epochs_df,</a>
<a class="sourceLine" id="cb8-10" data-line-number="10">       <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> time, <span class="dt">y =</span> observation,</a>
<a class="sourceLine" id="cb8-11" data-line-number="11">                     <span class="dt">group =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/interaction">interaction</a></span>(condition, epoch),</a>
<a class="sourceLine" id="cb8-12" data-line-number="12">                     <span class="dt">color =</span> condition)) <span class="op">+</span></a>
<a class="sourceLine" id="cb8-13" data-line-number="13"><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">size =</span> <span class="fl">0.3</span>, <span class="dt">alpha =</span> <span class="fl">0.4</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb8-14" data-line-number="14"><span class="st">  </span><span class="kw">geom_line</span>(</a>
<a class="sourceLine" id="cb8-15" data-line-number="15">    <span class="dt">size =</span> <span class="fl">1.5</span>, <span class="dt">data =</span> probe,</a>
<a class="sourceLine" id="cb8-16" data-line-number="16">    <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> time, <span class="dt">y =</span> pred, <span class="dt">group =</span> condition,</a>
<a class="sourceLine" id="cb8-17" data-line-number="17">                  <span class="dt">color =</span> condition)) <span class="op">+</span></a>
<a class="sourceLine" id="cb8-18" data-line-number="18"><span class="st">  </span><span class="kw">theme_minimal</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb8-19" data-line-number="19"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">text =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">24</span>, <span class="dt">family =</span> <span class="st">"Helvetica"</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb8-20" data-line-number="20"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">"times [ms]"</span>,</a>
<a class="sourceLine" id="cb8-21" data-line-number="21">       <span class="dt">y =</span> <span class="st">"predicted GRAD signal [fT/cm]"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb8-22" data-line-number="22"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot.window">ylim</a></span>(<span class="op">-</span><span class="dv">300</span>, <span class="dv">300</span>)</a></code></pre></div>
<p><img src="plot_evoked_multilevel_model_files/figure-html/unnamed-chunk-5-1.png" width="768"></p>
<p>We can see that the model predictions are recapitulating the temporal structure of the data. But how much uncertainty do we have about those predicrions?</p>
<p>In the absence of a full Bayesian analysis we can do an informed parametric bootstrap that takes into account all sources of uncertainty of our multilevel model, which yields more conservative estimates of compatibility intervals. We will use the <a href="https://cran.r-project.org/web/packages/merToolsl"><code>merTools</code></a> package for this purpose.</p>
<p>We’ll put a few custom options which should speak for themselves.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">pred_interval_mod1 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/merTools/topics/predictInterval">predictInterval</a></span>(</a>
<a class="sourceLine" id="cb9-2" data-line-number="2">  <span class="dt">merMod =</span> mod1, <span class="dt">newdata =</span> probe, <span class="dt">which =</span> <span class="st">"full"</span>, <span class="dt">level =</span> <span class="fl">0.95</span>,</a>
<a class="sourceLine" id="cb9-3" data-line-number="3">  <span class="dt">n.sims =</span> <span class="dv">1000</span>, <span class="dt">stat =</span> <span class="st">"mean"</span>, <span class="dt">type =</span> <span class="st">"linear.prediction"</span>,</a>
<a class="sourceLine" id="cb9-4" data-line-number="4">  <span class="dt">returnSims =</span> T, <span class="dt">seed =</span> <span class="dv">42</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5">)</a>
<a class="sourceLine" id="cb9-6" data-line-number="6"></a>
<a class="sourceLine" id="cb9-7" data-line-number="7">probe_int &lt;-<span class="st"> </span><span class="kw">bind_cols</span>(</a>
<a class="sourceLine" id="cb9-8" data-line-number="8">  probe, pred_interval_mod1)</a></code></pre></div>
<p>Let’s first look at the compatibility intervals.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw">ggplot</span>(</a>
<a class="sourceLine" id="cb10-2" data-line-number="2">    <span class="dt">data =</span> probe_int,</a>
<a class="sourceLine" id="cb10-3" data-line-number="3">    <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> time, <span class="dt">y =</span> pred, <span class="dt">group =</span> condition,</a>
<a class="sourceLine" id="cb10-4" data-line-number="4">                  <span class="dt">color =</span> condition, <span class="dt">ymin =</span> lwr, <span class="dt">ymax =</span> upr)) <span class="op">+</span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">fill =</span> condition), <span class="dt">alpha =</span> <span class="fl">0.1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">size =</span> <span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7"><span class="st">  </span><span class="kw">theme_minimal</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb10-8" data-line-number="8"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">text =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">20</span>, <span class="dt">family =</span> <span class="st">"Helvetica"</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb10-9" data-line-number="9"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">"times [ms]"</span>,</a>
<a class="sourceLine" id="cb10-10" data-line-number="10">       <span class="dt">y =</span> <span class="st">"predicted GRAD signal [fT/cm]"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb10-11" data-line-number="11"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>condition) <span class="op">+</span></a>
<a class="sourceLine" id="cb10-12" data-line-number="12"><span class="st">  </span><span class="kw">guides</span>(<span class="dt">color =</span> F, <span class="dt">fill =</span> F)</a></code></pre></div>
<p><img src="plot_evoked_multilevel_model_files/figure-html/unnamed-chunk-7-1.png" width="768"></p>
<p>Now let’s plot the single simulations on top of it. We first have to extract the simulations from the <code>merTools</code> output.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="co"># let's subsample a few bootstrap simulations.</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2">idx &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sample">sample</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">1000</span>, <span class="dt">size =</span> <span class="dv">100</span>)</a>
<a class="sourceLine" id="cb11-3" data-line-number="3"></a>
<a class="sourceLine" id="cb11-4" data-line-number="4">pred_sims &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/attr">attr</a></span>(pred_interval_mod1, <span class="st">"sim.results"</span>)[,idx] <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.data.frame">as.data.frame</a></span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-6" data-line-number="6"><span class="st">  </span><span class="kw">gather</span>(<span class="dt">key =</span> <span class="st">"sim"</span>, <span class="dt">value =</span> <span class="st">"pred_hat"</span>)</a>
<a class="sourceLine" id="cb11-7" data-line-number="7"></a>
<a class="sourceLine" id="cb11-8" data-line-number="8">pred_sims<span class="op">$</span>sim &lt;-<span class="st"> </span>pred_sims<span class="op">$</span>sim <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>()</a>
<a class="sourceLine" id="cb11-9" data-line-number="9">pred_sims<span class="op">$</span>time &lt;-<span class="st"> </span>probe_int<span class="op">$</span>time</a>
<a class="sourceLine" id="cb11-10" data-line-number="10">pred_sims<span class="op">$</span>condition &lt;-<span class="st"> </span>probe_int<span class="op">$</span>condition</a>
<a class="sourceLine" id="cb11-11" data-line-number="11">pred_sims<span class="op">$</span>pred &lt;-<span class="st"> </span>probe_int<span class="op">$</span>pred</a></code></pre></div>
<p>Now we can plot the prediction from each bootstrap replica. In order to not clutter things we will make generous use of transparency.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="kw">ggplot</span>(</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">    <span class="dt">data =</span> pred_sims,</a>
<a class="sourceLine" id="cb12-3" data-line-number="3">    <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> time, <span class="dt">y =</span> pred,</a>
<a class="sourceLine" id="cb12-4" data-line-number="4">                  <span class="dt">group =</span> condition,</a>
<a class="sourceLine" id="cb12-5" data-line-number="5">                  <span class="dt">color =</span> condition)) <span class="op">+</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_line</span>(</a>
<a class="sourceLine" id="cb12-7" data-line-number="7">    <span class="dt">alpha =</span> <span class="fl">0.05</span>, <span class="dt">mapping =</span> <span class="kw">aes</span>(</a>
<a class="sourceLine" id="cb12-8" data-line-number="8">      <span class="dt">y =</span> pred_hat,</a>
<a class="sourceLine" id="cb12-9" data-line-number="9">      <span class="dt">group =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/interaction">interaction</a></span>(sim, condition))) <span class="op">+</span></a>
<a class="sourceLine" id="cb12-10" data-line-number="10"><span class="st">  </span><span class="kw">stat_summary</span>(</a>
<a class="sourceLine" id="cb12-11" data-line-number="11">      <span class="dt">fun.ymin =</span> <span class="cf">function</span>(x){<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/quantile">quantile</a></span>(x, <span class="fl">0.025</span>)},</a>
<a class="sourceLine" id="cb12-12" data-line-number="12">      <span class="dt">fun.ymax =</span> <span class="cf">function</span>(x){<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/quantile">quantile</a></span>(x, <span class="fl">0.975</span>)},</a>
<a class="sourceLine" id="cb12-13" data-line-number="13">      <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> time,</a>
<a class="sourceLine" id="cb12-14" data-line-number="14">                    <span class="dt">y =</span> pred_hat,</a>
<a class="sourceLine" id="cb12-15" data-line-number="15">                    <span class="dt">fill =</span> condition,</a>
<a class="sourceLine" id="cb12-16" data-line-number="16">                    <span class="dt">group =</span> condition,</a>
<a class="sourceLine" id="cb12-17" data-line-number="17">                    <span class="dt">color =</span> condition),</a>
<a class="sourceLine" id="cb12-18" data-line-number="18">      <span class="dt">geom =</span> <span class="st">"ribbon"</span>, <span class="dt">alpha =</span> <span class="fl">0.1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb12-19" data-line-number="19"><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">size =</span> <span class="fl">1.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb12-20" data-line-number="20"><span class="st">  </span><span class="kw">theme_minimal</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb12-21" data-line-number="21"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">text =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">20</span>, <span class="dt">family =</span> <span class="st">"Helvetica"</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb12-22" data-line-number="22"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">"times [ms]"</span>,</a>
<a class="sourceLine" id="cb12-23" data-line-number="23">       <span class="dt">y =</span> <span class="st">"predicted GRAD signal [fT/cm]"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb12-24" data-line-number="24"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>condition) <span class="op">+</span></a>
<a class="sourceLine" id="cb12-25" data-line-number="25"><span class="st">  </span><span class="kw">guides</span>(<span class="dt">color =</span> F, <span class="dt">fill =</span> F)</a></code></pre></div>
<p><img src="plot_evoked_multilevel_model_files/figure-html/unnamed-chunk-9-1.png" width="768"></p>
<p>While we see a clear condition-relative modulation of the signal, at the same time we have to appreciate considerable uncertainty.</p>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Denis Engemann.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
